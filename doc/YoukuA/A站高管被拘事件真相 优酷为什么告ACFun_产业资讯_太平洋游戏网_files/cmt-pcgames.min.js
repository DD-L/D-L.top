(function(CommentNS,exports){exports.requestAnimationFrame=exports.requestAnimationFrame||exports.mozRequestAnimationFrame||exports.webkitRequestAnimationFrame||exports.msRequestAnimationFrame||exports.oRequestAnimationFrame||function(callback){return setTimeout(callback,1000/60);
};exports.cancelAnimationFrame=exports.cancelAnimationFrame||exports.mozCancelAnimationFrame||exports.webkitCancelAnimationFrame||exports.msCancelAnimationFrame||exports.oCancelAnimationFrame||function(callback){return clearTimeout(callback,1000/60);
};if(typeof Object.create!=="function"){Object.create=function(proto){var F=function(){};F.prototype=proto;return new F;};}var prefix=["webkit","moz","ms","o"];
var support=(function(){var testElem=document.createElement("otarim"),testStyle=testElem.style;var test=function(cssText){testStyle.cssText=cssText;};var support={opacity:(function(){test("opacity: .5");
return(/^0.5$/).test(testStyle.opacity);})()};return support;})();var cssHooks={opacity:{get:function(el){var ropacity=/opacity=([^)]*)/,ret;if(!support.opacity&&el.currentStyle){ret=ropacity.test(el.currentStyle.filter||"")?(parseFloat(RegExp.$1)/100)+"":"";
return ret===""?"1":ret;}ret=document.defaultView.getComputedStyle(el,null).getPropertyValue("opacity");return ret;},set:function(el,value){var style=el.style,ralpha=/alpha\([^)]*\)/,opacity,filter;
if(!support.opacity){style.zoom=1;opacity=isNaN(+value)?"":"alpha(opacity="+value*100+")";if(value>=1){opacity="";}filter=style.filter||"";style.filter=ralpha.test(filter)?filter.replace(ralpha,opacity):opacity;
}else{el.style.opacity=value;}}}};var getStyle=(function(){var rnumpx=/^-?\d+(?:px)?$/i,rnum=/^-?\d/;var postFix=function(el,prop,value){var style=el.style,left=el.runtimeStyle.left,ret;
if(prop.toLowerCase()==="fontSize"){value="1em";}style.left=value;ret=style.pixelLeft;el.runtimeStyle.left=left;return ret;};if(document.defaultView&&document.defaultView.getComputedStyle){return function(el,prop){if(cssHooks[prop]){return cssHooks[prop].get(el,prop);
}return document.defaultView.getComputedStyle(el,null).getPropertyValue(prop);};}else{return function(el,prop){if(cssHooks[prop]){return cssHooks[prop].get(el);
}var ret=el.currentStyle[prop];if(!rnumpx.test(ret)&&rnum.test(ret)){ret=postFix(el,prop,ret);}return ret;};}})();var Effect={linear:function(a){return a;
},ease:function(a){return a*a;},"ease-in":function(a){return a*a*a;},"ease-out":function(a){return --a*a*a+1;},"ease-in-out":function(a){return(a*=2)<1?0.5*a*a*a:0.5*((a-=2)*a*a+2);
}};function coPrefixProp(prop){var style=document.createElement("a").style,l,origName;prop=camelCase(prop);if(prop.toLowerCase()==="float"){return !!style.cssFloat?"cssFloat":"styleFloat";
}if(prop in style){return prop;}origName=prop;prop=prop.charAt(0).toUpperCase()+prop.slice(1);l=prefix.length;while(l--){if(prefix[l]+prop in style){return prefix[l]+prop;
}}return origName;}function vendorPropName(props){var ret={};for(var i in props){if(props.hasOwnProperty(i)){ret[coPrefixProp(i)]=props[i];}}return ret;
}function camelCase(el){return el.replace(/-([a-z])/gi,function(all,letter){return letter.toUpperCase();});}function Animate(elem,props,duration,effect,callback){var self=this;
if(!(this instanceof Animate)){self=Object.create(Animate.prototype);}self.queue=[];self.elem=elem;self.targetProps=props;self.duration=duration||400;self.timer=null;
self.effect=Effect[effect]||Effect.linear;self.callback=callback;self.init();return self;}Animate.prototype={init:function(){this.makeAnimateQueue();this.doAnimate();
},makeAnimateQueue:function(){var targetProps=this.targetProps;var getInitalStyle=function(el,targetProps){var ret={el:el,style:{}};for(var i in targetProps){if(targetProps.hasOwnProperty(i)){ret.style[i]=+(getStyle(el,i))||0;
}}return ret;};if(this.elem.length){for(var i=0,l=this.elem.length;i<l;i++){this.queue.push(getInitalStyle(this.elem[i],targetProps));}}else{this.queue.push(getInitalStyle(this.elem,targetProps));
}targetProps=vendorPropName(targetProps);},doAnimate:function(){var t=new Date,duration=this.duration,rUnit=/[a-z]+$/,targetProps=this.targetProps,self=this,step;
var calc=function(){if((step=(new Date-t)/duration)>=1){cancelAnimationFrame(self.timer);setValue(true);self.callback&&self.callback();}else{setValue();
self.timer=requestAnimationFrame(calc);}};var getUnit=function(prop){return prop==="opacity"?"":"px";};var setValue=function(done){var unit,initStyle,tmpValue;
for(var i=0,l=self.queue.length;i<l;i++){initStyle=self.queue[i].style;style=self.queue[i].el.style;for(var j in targetProps){if(targetProps.hasOwnProperty(j)){if(done){tmpValue=parseFloat(targetProps[j]);
}else{tmpValue=self.effect(step)*(parseInt(targetProps[j],10)-parseInt(initStyle[j],10))+parseInt(initStyle[j],10);}if(cssHooks[j]){cssHooks[j].set(self.queue[i].el,tmpValue);
continue;}style[j]=tmpValue+getUnit(j);}}}};calc();},stop:function(){cancelAnimationFrame(this.timer);}};var ns=CommentNS;var CONFIG={cmuName:ns.cmuName||"cmu",sidName:ns.sidName||"common_session_id",loginUrl:ns.loginUrl||"http://passport2.pcgames.com.cn/passport2/passport/login.jsp",logoutUrl:ns.logoutUrl||"http://passport2.pcgames.com.cn/passport2/passport/logout.jsp",elId:ns.elId||"comment_tag",pageUrl:ns.pageUrl||location.href,title:document.title,baseUrl:ns.baseUrl||"http://cmt.pcgames.com.cn",domain:".pcgames.com.cn",postUrl:"/action/comment/create.jsp?encodeHtml=1",getUrl:"/action/comment/list_new_json.jsp?urlHandle=1&encodeHtml=1",ipUrl:"http://whois.pconline.com.cn/ipJson.jsp",userUrl:"http://my.pcgames.com.cn/intf/getLogedUser.jsp",tidUrl:"/intf/url2tid.jsp?urls=",countUrl:"/action/topic/get_data.jsp?url=",authoUrl:"http://my.pcgames.com.cn/passport/opens/authorize.jsp",bindUrl:"http://my.pcgames.com.cn/passport/opens/open_bind.jsp",bindStatusUrl:"http://passport2.pcgames.com.cn/passport2/api/bind_status.jsp",voteUrl:"/action/comment/support.jsp",bindDoneUrl:"http://my.pcgames.com.cn/passport/opens/bind_done.jsp",oauthUrl:"http://passport2.pcgames.com.cn/passport2/api/open_oauth.jsp?loginBind=",proxyUrl:"http://cmt.pcgames.com.cn/blank.html",faceUrl:"http://my.pcgames.com.cn/setting/face.jsp",defaultAvatar:"http://i1.3conline.com/images/upload/upc/face/0/0_100x100",usercenterUrl:"http://my.pcgames.com.cn/",captchaUrl:"http://captcha.pcgames.com.cn/captcha/v.jpg?",appUrl:"http://app.pcgames.com.cn/appcenter/",cmtCssUrl:"http://js.pcgames.com.cn/pcgames/common/css/cmt.css",registerUrl:"http://my.pcgames.com.cn/passport/register.jsp",forgotUrl:"http://my.pcgames.com.cn/passport/forgot_password.jsp",sign:"games",pageEncoding:document.charset||"GB2312",max_comment_count:5,COOKIE_NAME_IP:"CMT_IP",UN_AUDIT_COOKIE_NAME:"CMT4_UN_AUDIT_",UN_AUDIT_MSG:"(感谢参与评论,您的评论内容将在审核后公开。)",MAX_COMMENT_COUNT:5,limit:15,shareToken:"太平洋游戏网",topicid:"",needCaptcha:0};
function preventDefault(a){return a=window.event||a,a.preventDefault?a.preventDefault():a.returnValue=!1,!0;}function getData(a,b){return"dataset" in a?a.dataset[b]:a.getAttribute("data-"+b);
}function setData(a,b,c){return"dataset" in a?a.dataset[b]=c:a.setAttribute("data-"+b,c);}function jsonp(a,b,c,d){var c=c||"jsonp"+Math.random().toString(32).slice(2),e=document.createElement("script");
if(d){for(var f in d){d.hasOwnProperty(f)&&e.setAttribute(f,d[f]);}}exports[c]=function(a){b&&b(a),e.parentNode.removeChild(e),e=null;},e.src=-1!==a.indexOf("?")?a+"&callback="+c:a+"?callback="+c,document.getElementsByTagName("head")[0].appendChild(e);
}var eventHub={},isIE=typeof addEventListener!=="function",map={mouseenter:{type:"mouseover",target:"fromElement"},mouseleave:{type:"mouseout",target:"toElement"}},specialTypes={focus:isIE?"focusin":"focus",blur:isIE?"focusout":"blur"},addEvent=function(){var a=function(a,b){return a.compareDocumentPosition?0!==(16&a.compareDocumentPosition(b)):a.contains(b);
},b=function(b,c,d,e){var f,g,h=d,i=!1;return("mouseenter"===c||"mouseleave"===c)&&(g=c,c=map[g].type,d=function(c){var c=window.event||c;f=c.relatedTarget||c[map[g].target],a(b,f)||b===f?c.stopPropagation?c.stopPropagation():c.cancelBubble=!0:h.call(b,c);
},eventHub[g]=eventHub[g]||[],eventHub[g].push({_callback:h,callback:d})),("blur"===c||"focus"===c)&&(i=!0,c=specialTypes[c]),e.call(b,c,d,i);};return"function"==typeof addEventListener?function(a,c,d){b(a,c,d,function(b,c,d){return a.addEventListener(b,c,d);
});}:function(a,c,d){b(a,c,d,function(b,c){return a.attachEvent("on"+b,c);});};}(),removeEvent=function(){var a=function(a,b,c,d){var e,f,g=!1;if("mouseenter"===b||"mouseleave"===b){e=eventHub[b],f=b,b=map[f].type;
for(var h=0;h<e.length;h++){if(c===e[h]._callback){c=e[h].callback;break;}}}return("blur"===b||"focus"===b)&&(g=!0,b=specialTypes[b]),d.call(a,b,c,g);};
return"function"==typeof removeEventListener?function(b,c,d){a(b,c,d,function(a,c,d){return b.removeEventListener(a,c,d);});}:function(b,c,d){a(b,c,d,function(a,c){return b.attachEvent("on"+a,c);
});};}(),getElementsByClassName;getElementsByClassName=document.getElementsByClassName?function(a,b){return b=b||document,b.getElementsByClassName(a);}:function(a,b){b=b||document;
for(var c,d=[],e=b.getElementsByTagName("*"),f=new RegExp("(^|\\s)"+a+"(\\s|$)"),g=0,h=e.length;h>g;g++){c=e[g],f.test(c.className)&&d.push(c);}return e=void 0,d;
};var getParent=function(a,b){for(var c=a,d=new RegExp("(^|\\s)"+b+"(\\s|$)");c&&!d.test(c.className)&&(c=c.parentNode);){}return c;},getEvent=function(target,eventType){var ret={};
while(target!==document&&!(ret.value=getData(target,eventType))){target=target.parentNode;}ret.target=target;return ret;},getChild=function(a,b){for(var c,d=a.firstChild;
d;){if(1===d.nodeType&&b(d)===!0){c=d;break;}d=d.nextSibling;}return c;},isContain=function(a,b){try{return a.contains?a!=b&&a.contains(b):!!(16&a.compareDocumentPosition(b));
}catch(c){return !1;}},extend=function(){var a=function(){};return function(b,c){a.prototype=b.prototype,c.prototype=new a,c.constructor=c;};}();var getObjectKeys=function(obj,key){var count=0;
while(obj[key]){count++;obj=obj[key];}obj=null;return count;};var addClass=function(el,className){var classes=el.className?" "+el.className+" ":" ",className=className.split(/\s/),index=0,clazz;
while(clazz=className[index++]){if(classes.indexOf(" "+clazz+" ")<0){classes+=clazz+" ";}}el.className=classes.replace(/(^\s*)|(\s*$)/g,"");return el;};
var removeClass=function(el,className){if(!el.className){return el;}var classes=" "+el.className+" ",className=className.split(/\s/),index=0,clazz;while(clazz=className[index++]){classes=classes.replace(" "+clazz+" ","");
}el.className=classes.replace(/(^\s*)|(\s*$)/g,"");return el;};[].forEach||(Array.prototype.forEach=function(a,b){for(var c=0,d=this.length;d>c;c++){a.apply(b||null,[this[c],c,this]);
}return this;});!function(){function a(a,b,c){void 0===c&&(c=!0);for(var d in b){!b.hasOwnProperty(d)||!c&&a.hasOwnProperty(d)||(a[d]=b[d]);}}function c(c,d,e){e=e||{},a(e,b,!1),null===d&&(e.expires=-1);
var f=e.expires,g=e.path,h=e.domain,i=e.secure;if("number"==typeof f){var j=f;f=new Date,f.setDate(f.getDate()+j);}var k=[encodeURIComponent(c),"=",encodeURIComponent(d),f?"; expires="+f.toUTCString():"",g?"; path="+g:"",h?"; domain="+h:"",i?"; secure":""].join("");
return document.cookie=k,k;}function d(a){return new RegExp("(?:^|;\\s*)"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie);
}function e(a){if(!a||!d(a)){return null;}var b=document.cookie.replace(new RegExp("(?:^|.*;\\s*)"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1");
return decodeURIComponent(b);}var b={path:"",domain:"",secure:!1};window.Cookie={set:c,get:e,has:d};}();function postCORS(a,b,c,d){var e=createCORSRequest();
if(e){e.open("POST",a),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),d&&d.withCookie&&(e.withCredentials=!0),e.onreadystatechange=function(){var a={isXhr:!0};
4==e.readyState&&(200==e.status||304==e.status?(a.status="success",b(e.responseText,a)):(a.status="error",b(e,a)));};var g=[];for(var h in c){c.hasOwnProperty(h)&&g.push(encodeURIComponent(h)+"="+encodeURIComponent(c[h]));
}e.send(g.join("&"));}else{var f=new Transfer(a,function(a){b(a,{isHxr:!1});},{params:c});f.send();}}function createCORSRequest(){var a;try{a=new XMLHttpRequest,"withCredentials" in a||(a=null);
}catch(b){a=null;}return a;}function Transfer(a,b,c){this.url=a,this.callback=b;var d={localProxy:"/favicon.ico",defaultName:"cross.default.name"};this.options=this.extend(d,c),this.init();
}Transfer.prototype={init:function(){function a(a,b){var c=null;try{c=document.createElement("<"+a+' name="'+b+'">');}catch(d){}return c&&c.nodeName==a.toUpperCase()||(c=document.createElement(a),c.name=b),c;
}this.params=this.options.params||{},this.params.windowname=1,delete this.options.params,this.files=this.options.files||[],delete this.options.files;var b="transfer_"+(new Date).getTime();
this.options.defaultName=b;var c=a("iframe",b);c.name=b,c.style.display="none",c.style.position="fixed",c.style.top=c.style.left="-10000px",document.body.appendChild(c);
var d=document.createElement("form");d.style.display="none",d.target=b,d.action=this.url,d.method="post",d.encoding=d.enctype="application/x-www-form-urlencoded",document.body.appendChild(d),this.frame=c,this.form=d,this.state=1,this._setRequest();
},_setRequest:function(){function f(){var c;try{c=b.contentWindow.name;}catch(e){c=d.defaultName;}c==d.defaultName&&(c='{"error": 1}'),a.callback(c);}function g(){var a=!1;
try{a=b.contentWindow.location.host==location.host;}catch(c){}return a;}function h(){if(clearTimeout(j),b.onreadystatechange=b.onload=null,b.parentNode.removeChild(b),c){for(var d,e=0,f=a._files.length;
f>e;e++){d=a._files[e],d[2].insertBefore(d[0],d[1]),d[2].removeChild(d[1]);}d=null,a._files=[],c.parentNode.removeChild(c);}b=null,c=null;for(var g in a){a.hasOwnProperty(g)&&(a[g]=null,delete a[g]);
}}function k(){try{if("about:blank"==b.contentWindow.location.href){return;}}catch(c){}if(3==a.state){if(g()||i){if(b.readyState&&!/complete|loaded/i.test(b.readyState)){return;
}f(),h();}else{i=!0,b.contentWindow.location=e;}}2==a.state&&(a.state=3,b.contentWindow.location=e),j||(j=setTimeout(function(){f(),h();},120000));}var a=this,b=a.frame,c=a.form,d=a.options,e=d.localProxy;
void 0!==b.onreadystatechange?b.onreadystatechange=k:b.onload=k;var j,i=!1;},send:function(){function p(a,b){var c=document.createElement("input");return c.name=a,c.value=b,c;
}var d,e,a=this.params,b=this.files,c=this.form,f=Object.prototype.toString;for(d in a){if(a.hasOwnProperty(d)){if(e=a[d],"[object Array]"===f.call(e)){for(var g=d+"[]",h=0,i=e.length;
i>h;h++){c.appendChild(p(g,e[h]));}}else{c.appendChild(p(d,e));}}}var j,k,l,m=this._files=[],n=b.length;if(n>0){c.encoding=c.enctype="multipart/form-data";
for(var o=0;n>o;o++){j=b[o],k=j.parentNode,l=j.cloneNode(),l.disabled="disabled",m.push([j,l,k]),k.insertBefore(l,j),c.appendChild(j);}}j=k=l=null,c.submit(),this.state=2;
},isObject:function(a){return a&&"[object Object]"==Object.prototype.toString.call(a)&&!a.nodeType;},isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a);
},extend:function(a,b){var d,c=this.clone(b);for(d in c){c.hasOwnProperty(d)&&(a[d]=c[d]);}return a;},clone:function(a){var c,b=this;if(b.isArray(a)){c=[];
for(var d=0,e=a.length;e>d;d++){c.push(b.clone(a[d]));}}else{if(b.isObject(a)){c={};for(var f in a){a.hasOwnProperty(f)&&(c[f]=b.clone(a[f]));}}else{c=a;
}}return c;}};var hiddenInput=(function(){var el=document.createElement("input");el.setAttribute("tabIndex",-1);el.style.cssText=";width:1px;height:1px;border:none;margin:0;padding:0;display:none;";
document.body.insertBefore(el,document.body.firstChild);return el;})();var _={};var common={authoQQ:CONFIG.authoUrl+"?type=qzone_"+CONFIG.sign+"&return="+CONFIG.pageUrl+"&bind_url="+encodeURIComponent(CONFIG.bindUrl)+"?return="+CONFIG.pageUrl,authowb:CONFIG.authoUrl+"?type=sina_"+CONFIG.sign+"&return="+CONFIG.pageUrl+"&bind_url="+encodeURIComponent(CONFIG.bindUrl)+"?return="+CONFIG.pageUrl,authotb:CONFIG.authoUrl+"?type=taobao_"+CONFIG.sign+"&return="+CONFIG.pageUrl+"&bind_url="+encodeURIComponent(CONFIG.bindUrl)+"?return="+CONFIG.pageUrl,editors:{},instances:{},cmts:{},generator:function(prefix){return prefix+Math.random().toString(32).slice(2);
},getTid:function(callback){if(CONFIG.topicid){return callback&&callback(CONFIG.topicid);}else{jsonp(CONFIG.baseUrl+CONFIG.tidUrl+CONFIG.pageUrl,function(data){if(data[0].topicid){CONFIG.topicid=data[0].topicid;
return callback&&callback(CONFIG.topicid);}else{return callback&&callback(null);}});}},getEmotions:function(){var ret=["<textarea>"],map=["[嘻嘻]","[酷]","[汗]","[鄙视]","[阴险]","[强]","[弱]","[花]","[便便]","[亲]"];
for(var i=201;i<211;i++){ret.push('<img src="http://www.pconline.com.cn/images/comment/face'+i+'.gif" data-event="addEmotion" title="'+map.shift()+'">');
}ret.push("</textarea>");return ret.join("");},toggleEmotion:function(el){var slider=getElementsByClassName("cmtarea-account-emotions-list",el.parentNode)[0],displayStatus=getData(slider,"show"),clickAnywhere=false;
if(displayStatus==="false"){setData(slider,"show","true");common.lazyload(slider);slider.style.cssText+=";display: block;";}else{setData(slider,"show","false");
slider.style.cssText+=";display: none;";}},addEmotion:function(content,el){this.focusForm(content);var parentEmotion=el.parentNode,html='<img src="'+el.src+'">';
var ele=content;var doc=document;var self=this,range;ele.focus();setTimeout(function(){if(doc.selection){range=self.lastSelectedRange||doc.selection.createRange();
var cnode=range.parentElement();if(cnode!==ele&&!isContain(ele,cnode)){ele.focus();range=doc.selection.createRange();}range.pasteHTML(html+"&nbsp;");}else{var selection=doc.getSelection();
if(selection){if(selection.rangeCount<1){return;}range=selection.getRangeAt(0);}else{range=doc.createRange();}var oFragment=range.createContextualFragment(html),oLastNode=oFragment.lastChild;
range.insertNode(oFragment);range.setEndAfter(oLastNode);range.setStartAfter(oLastNode);selection.removeAllRanges();selection.addRange(range);}self.recordPos();
self.toggleEmotion(parentEmotion);},0);},lazyload:function(el){var getFirstElementChild=function(el){var ret;if(ret=el.firstElementChild){return ret;}else{ret=el.firstChild;
while(ret&&ret.nodeType!==1){ret=ret.nextSibling;}return ret;}};var lazyToken=getFirstElementChild(el);if(lazyToken.tagName.toLowerCase()==="textarea"){el.innerHTML=lazyToken.value;
}},getData:function(el,callback){var data={isEncode:1,content:encodeURI(el.getContent()),captcha:el.getCaptcha(),needCaptcha:el.needCaptcha,url:el.cmtUrl,title:encodeURI(el.cmtTitle),columnId:"",area:"",replyFloor2:el.replyFloor||0,partId:"",syncsites:UserControl.getSyncStr()};
callback&&callback(data);},post:function(el,callback){var editor=common.editors[getData(el,"rel")],self=this;if(this.getStatus(el)==="false"){if(this.validate(el)){this.changeStatus(el);
this.getData(editor,function(data){postCORS(CONFIG.baseUrl+CONFIG.postUrl,function(ret){setTimeout(function(){editor.clean();self.changeStatus(el);},0);
callback(ret);},data,{withCookie:true});});}}},validate:function(el){var editor=common.editors[getData(el,"rel")],content=editor.content,isEmpty=getData(content,"empty");
if(isEmpty==="true"){alert("评论内容不能为空！");content.focus();return false;}if(editor.getContent().length>500){alert("评论内容字数不能超过500！");content.focus();return false;
}return true;},getStatus:function(el,type){return getData(el,type||"disabled");},changeStatus:function(el,type){type=type||"disabled";var value=getData(el,type),_value;
if(value==="false"){_value="true";}else{_value="false";}setData(el,type,_value);},RenderComment:function(el,data,refHtml){data=eval("("+data+")");var needCaptcha=data.resultCode===-9;
this.bookmark=this.lastSelectedRange=null;if(needCaptcha){el.showCaptcha();common.changeCaptcha(el);}else{if(data.commentCount>CONFIG.MAX_COMMENT_COUNT||CONFIG.needCaptcha){el.showCaptcha();
common.changeCaptcha(el);}else{el.hideCaptcha();}}if(data.resultCode!=-8&&data.resultCode!=1&&data.resultCode!=0){alert(data.resultMsg);return;}if(el.needCaptcha){common.changeCaptcha(el);
}common.renderNewComment(el.cmtContent,data,refHtml);common.updateCmtCount(el);refHtml&&(el.cmtContent.scrollIntoView(),replyEditor.close());},renderNewComment:function(el,data,reply){var content=el,newComment;
if(reply){newComment=(new Reply({data:data,replyTpl:reply,isQuote:true},true)).render();}else{newComment=(new Reply({data:data},true)).render();}content.insertBefore(newComment,content.firstChild);
},recordPos:function(){var doc=document;var range;if(doc.selection){range=doc.selection.createRange();range.collapse(false);this.lastSelectedRange=range;
}else{var selection=doc.getSelection();if(selection){if(selection.rangeCount<1){return;}range=selection.getRangeAt(0);this.bookmark=1;this.markEle=range.startContainer;
this.markOffset=range.startOffset;this.markEndEle=range.endContainer;this.markEndOffset=range.endOffset;}}},focusForm:function(content){var editor=content;
var doc=document;var range;editor.focus();if(doc.selection){if(this.lastSelectedRange){range=this.lastSelectedRange;range.select();}else{range=doc.selection.createRange();
range.moveToElementText(editor);range.select();range.collapse(false);range.select();}}else{var selection=doc.getSelection();if(!selection||selection.rangeCount<1){}else{if(!this.bookmark&&editor.childNodes.length){selection.removeAllRanges();
range=doc.createRange();range.selectNodeContents(editor);range.collapse(false);selection.addRange(range);}else{if(this.bookmark){selection.removeAllRanges();
range=doc.createRange();range.setStart(this.markEle,this.markOffset);range.setEnd(this.markEndEle,this.markEndOffset);range.collapse(false);selection.addRange(range);
this.bookmark=null;}}}}},vote:(function(){var msg="";var complete=function(el){var num=el.getElementsByTagName("b")[0],plus=el.getElementsByTagName("i")[0];
el.style.cssText+="color: #ccc";plus.style.cssText+=";opacity: 1;filter: alpha(opacity=100)";Animate(plus,{top:-30,opacity:0},2000,"ease-out",function(){num.innerHTML++;
});};return function(el){var id=getData(el,"id"),voteStatus=getData(el,"disabled"),postData;if(voteStatus==="true"){alert(msg);return;}else{postData={version:2,cid:id,sp:1,r:Math.random()};
postCORS(CONFIG.baseUrl+CONFIG.voteUrl,function(data){data=eval("("+data+")");if(data.msg){alert(data.msg);msg=data.msg;common.changeStatus(el);return;
}complete(el);},postData,{withCookie:true});}};})(),getCmtTpl:function(config){var tpl=(config.isPop?"":'<div class="cmtarea-header"><strong>网友评论</strong><span class="cmtarea-cmtCount"></span></div>')+'<div class="cmtarea-section"><div class="cmtarea-tools"><div class="cmtarea-account"><a href="#" class="cmtarea-account-login" data-event="cmtlogin">通行证登录</a><a href="'+CONFIG.registerUrl+'" target="_blank">注册</a><b class="cmtarea-account-separator">|</b><a href="'+this.authoQQ+'" target="_blank" class="cmtarea-account-qq">QQ</a><a href="'+this.authowb+'" target="_blank" class="cmtarea-account-sina">微博</a><a href="'+this.authotb+'" target="_blank" class="cmtarea-account-tb">淘宝</a></div><div class="cmtarea-account-online"></div><div class="cmtarea-account-emotions"><span data-event="toggleEmotion" class="cmtarea-account-emotions-handler"><img src="http://www1.pconline.com.cn/images/comment/face201.png">表情</span><span class="cmtarea-account-emotions-list" data-show="false" data-rel="'+config.id+'">'+this.getEmotions()+"</span></div>"+(config.isPop?'<span class="cmtarea-tools-close" data-event="cmtClose"></span>':"")+'</div><div class="cmtarea-section-content">'+(config.isPop?"":'<div class="cmtarea-section-content-avator"><a href="'+CONFIG.usercenterUrl+'" target="_blank"><img src="'+UserControl.getAvator()+'" class="cmtarea-section-content-avatorHolder"width="50" height="50"></a><p><a href="'+CONFIG.faceUrl+'" target="_blank">修改头像</a></p></div>')+'<div class="cmtarea-section-content-editor" id="'+config.id+'" data-empty="true"></div></div></div><div class="cmtarea-footer"><span class="cmtarea-captcha" data-rel="'+config.id+'">验证码：<input name="captcha" class="cmtarea-captcha-value" type="text" title="5个字符 ~!.{5,5}"><img class="cmtarea-captcha-img" width="95" height="22"><a href="javascript:;" target="_self" class="cmtarea-captcha-change" data-event="cmtChangeCaptcha" data-target="'+config.uuid+'">看不清，换一张</a></span><span class="cmtarea-async">同步到:<em class="cmtarea-async-sina" data-type="sina" data-event="accountAsync"></em><em class="cmtarea-async-qzone" data-type="qzone" data-event="accountAsync"></em></span><a class="cmtarea-sendBtn" href="#" target="_blank" data-disabled="false" data-event="'+config.type+'" data-rel="'+config.id+'" data-target="'+config.uuid+'">发表评论</a></div>';
return tpl;},getCmtCount:function(count,cmtUrl,callback){var tpl;var getCount=function(callback){jsonp(CONFIG.baseUrl+CONFIG.countUrl+cmtUrl,function(data){tpl='<a href="'+data.url+'" target="_blank">共<em class="cmtDetail">'+count+"</em>条评论，查看全部&gt;&gt;</a>";
callback&&callback(tpl);});};if(count){return getCount(callback);}else{tpl="暂无评论，快来抢沙发！";return setTimeout(function(){callback(tpl);},0);}},updateCmtCount:function(el){var tpl;
if(el.hasCmt){[].forEach.call(getElementsByClassName("cmtDetail",el.parentEl),function(el){el.innerHTML++;});}else{el.hasCmt=true;this.getCmtCount(1,el.cmtUrl,function(tpl){[].forEach.call(getElementsByClassName("cmtarea-cmtCount",el.parentEl),function(el){el.innerHTML=tpl;
});});}},changeCaptcha:function(target){var src=CONFIG.captchaUrl+new Date().getTime();[].forEach.call(getElementsByClassName("cmtarea-captcha-img",target.parentEl),function(item){item.src=src;
});},resetCaptchaStatus:function(){var instance;CONFIG.needCaptcha=0;for(var i in common.instances){if(common.instances.hasOwnProperty(i)){instance=common.instances[i];
instance.hideCaptcha&&instance.hideCaptcha();}}},bdshare:function(focusBind){if(!_.hasbindBd||focusBind){_.hasbindBd=true;var ele1=document.createElement("script"),ele2=document.createElement("script");
ele1.id="bdshare_js";ele2.id="bdshell_js";ele1.setAttribute("data","type=tools&amp;uid=0");var tp=document.body;tp.insertBefore(ele1,tp.firstChild);tp.insertBefore(ele2,tp.firstChild);
exports.bds_config=exports.bbs_config||{snsKey:{tsina:"3549659419",tqq:""}};document.getElementById("bdshell_js").src="http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion="+Math.ceil(new Date()/3600000);
}},formatDate:(function(){var FULLYEAR=new Date().getFullYear(),ONEDAY=24*3600*1000,timestamp,now;var getServerTime=(function(){var xhr=(exports.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"));
return function(){if(now){return;}xhr.open("get","/favicon.ico?"+(+new Date),false);xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){now=new Date(xhr.getResponseHeader("Date"));
}}};xhr.send(null);};})();return function(time){getServerTime();timestamp=new Date(time.replace(/-/g,"/"));if(!isNaN(+timestamp)){if(now-timestamp<ONEDAY){time=Math.floor((now-timestamp)/ONEDAY*24);
if(time<=0){time=Math.ceil((now-timestamp)/ONEDAY*24*60)+"分钟前";}else{time+="小时前";}}}return time;};})(),getClient:(function(){var client=["PC","Android","iPhone","新浪","QQ","Wap","微信"],tpl='<span>来自<a href="'+CONFIG.appUrl+'" target="_blank">{{refer}}客户端</a></span>',referClient;
return function(code){var ret="",code=Number(code)-1,referToken;if(code===1||code===2){referToken=client[code];ret=tpl.replace(/{{refer}}/g,referToken);
}return ret;};})()};function Editor(){this.id=common.generator("editor_");this.needCaptcha=CONFIG.needCaptcha;}Editor.prototype={_init:function(){this.content=document.getElementById(this.id);
this.content.contentEditable=true;common.editors[this.id]=this;this.setPlaceHolder();},setPlaceHolder:function(){this.content.innerHTML=this.placeHolder;
this.content.style.color="#ccc";},bindEvent:function(){var self=this,content=this.content,sendBtn=this.sendBtn;var doFocus=function(){var isEmpty=getData(content,"empty"),value=self.getCleanText();
if(value==""||value===self.placeHolder){setData(content,"empty","true");content.style.color="#000";if(value===self.placeHolder){content.innerHTML="";}}else{setData(content,"empty","false");
}};var doBlur=function(){var isEmpty=getData(content,"empty"),value=self.getCleanText();if(value==""||value===self.placeHolder){setData(content,"empty","true");
if(value===""){content.innerHTML=self.placeHolder;content.style.color="#ccc";}}else{setData(content,"empty","false");}try{hiddenInput.setSelectionRange(0,0);
hiddenInput.blur();}catch(e){}};var recordPos=function(){setTimeout(function(){common.recordPos.call(common);},0);};addEvent(this.content,"focus",doFocus);
addEvent(this.content,"blur",doBlur);addEvent(this.content,"click",function(){common.recordPos.call(common);});addEvent(this.content,"keypress",function(){recordPos();
});addEvent(this.content,"keyup",recordPos);setTimeout(function(){content.blur();},1000);},getContent:function(){return this.getCleanText().replace(/&nbsp;/ig," ").replace(/&lt;/ig,"<").replace(/&gt;/ig,">");
},getCleanText:function(){var ele=this.content;var clone=ele.cloneNode(true);clone.innerHTML=this.html2txt(clone.innerHTML);this.stripTags(clone,"*");return clone.innerHTML.replace(/(?:\s|&nbsp;)*$/g,"");
},html2txt:function(html){var facePtn=/<img\ssrc=".*?face(\d{3})\.gif"\s*\/*>/igm;var res=html.replace(facePtn,function(m,m1){return"{"+m1+"}";}).replace(/&nbsp;/igm," ").replace(/(?:<br\s*\\?>)+/igm,"\n").replace(/<div>(.*?)<\/div>/igm,"\n$1").replace(/<p>(.*?)<\/p>/igm,"\n$1");
return res;},stripTags:function(el,tagName){var els=el.getElementsByTagName(tagName.toUpperCase());for(var i=0;i<els.length;i++){while(els[i].firstChild){els[i].parentNode.insertBefore(els[i].removeChild(els[i].firstChild),els[i]);
}els[i].parentNode.removeChild(els[i--]);}},getCaptcha:function(){return getElementsByClassName("cmtarea-captcha-value",this.editor)[0].value;},clean:function(){this.setPlaceHolder();
common.changeStatus(this.content,"empty");}};var Popbox=(function(){var merge=function(obj,target){for(var i in target){if(target.hasOwnProperty(i)){obj[i]=target[i];
}}return obj;};var coStyle=function(styleList){var ret=[";"];for(var i in styleList){if(styleList.hasOwnProperty(i)){ret.push(i+":"+styleList[i]);}}return ret.join(";");
};var addPrefix=function(property,value){var prefix=["-webkit-","-moz-","-ms-","-o-",""],ret=[];for(var i=0;i<prefix.length;i++){ret.push(prefix[i]+property+":"+value);
}return ret.join(";");};var getDocumentLayout=function(){return{docWidth:document.documentElement.scrollWidth||document.body.scrollWidth,docHeight:document.documentElement.scrollHeight||document.body.scrollHeight};
};var getViewLayout=function(){return{width:document.documentElement.scrollLeft+document.documentElement.clientWidth/2,height:document.documentElement.scrollTop+document.documentElement.clientHeight/2};
};var isIE6=typeof window.XMLHttpRequest==="undefined";var overlayIndex=popMaxzIndex=9998;var instances=[];var overlays=[];var hasBindShortcut=false;var hasBindResize=false;
function Popbox(config){var wrap=this.el=document.createElement("div");var self=this;var defaultEvent={"click#popClose":function(e,el){self.close();}};
this.zIndex=++popMaxzIndex;this.config=config||{};this.config.dragable&&this.bindDragEvent(defaultEvent);this.events=this.config.events&&merge(defaultEvent,config.events)||defaultEvent;
wrap.className="popbox-container_";wrap.style.cssText+=";position: fixed;display: none;top: 50%;left: 50%;z-index: "+this.zIndex;if(isIE6){wrap.style.position="absolute";
}this.config.style&&(wrap.style.cssText+=coStyle(config.style));wrap.innerHTML=this.config.el&&config.el.call(this,this.el)||"";document.body.insertBefore(wrap,document.body.firstChild);
instances.push({instance:this,el:this.el,zIndex:this.zIndex});this.config.overlay!==false&&this.buildOverlay();this.config.shortcut=config.shortcut||false;
this.bind();}Popbox.prototype={reDraw:function(callback,styleObj){styleObj&&(this.el.style.cssText+=coStyle(styleObj));this.el.innerHTML=callback.call(this,this.el);
this.layoutFix();return this;},bind:function(){var eventList=this.events,self=this;var todos=instances;var getEventList=function(target){return getData(target,"event")&&getData(target,"event").split(",")||[];
};var matchEvent=function(eventType,eventName){if(typeof[].indexOf==="function"){return eventType.indexOf(eventName)!==-1;}else{for(var i=0,l=eventType.length;
i<l;i++){if(eventType[i]===eventName){return true;}}return false;}};var toTop=(function(){var reZindex=function(arr,from,begin){for(l=arr.length;from<l;
from++){arr[from].el.style.zIndex=begin++;}};return function(){for(var i=0,l=todos.length;i<l;i++){if(todos[i].zIndex===self.zIndex){var who=todos.splice(i,1)[0],zIndex=who.el.style.zIndex;
todos.push(who);reZindex(todos,i,zIndex);break;}}};})();var doShortcut=function(e){e=window.event||e;var keyValue=e.keyCode||e.which;if(keyValue===27){for(var i=0,l=todos.length;
i<l;i++){self.close.call(todos[i].instance);}}};for(var i in eventList){if(eventList.hasOwnProperty(i)){(function(i){var customEvent=i.split("#");var callback=function(e){e=window.event||e;
var target=e.srcElement||e.target,eventType=getEventList(target);if(matchEvent(eventType,customEvent[1])){eventList[i].call(self,e,target);}};addEvent(self.el,customEvent[0],callback);
})(i);}}addEvent(this.el,"mousedown",toTop);if(this.config.shortcut&&!hasBindShortcut){hasBindShortcut=true;addEvent(document,"keydown",doShortcut);}},close:function(callback){this.toggleOverlay(false);
this.el.style.cssText+=";display: none;";callback&&callback.call(this);return this;},show:function(callback){this.toggleOverlay(true);this.el.style.cssText+=";display: block;";
this.layoutFix();callback&&callback.call(this);return this;},remove:function(){document.body.removeChild(this.el);this.overlayEl&&document.body.removeChild(this.overlayEl);
},buildOverlay:function(){this.overlayEl=overlay=document.createElement("div");overlays.push(overlay);overlay.style.cssText+=";position: absolute;display: none;width: "+getDocumentLayout().docWidth+"px;height: "+getDocumentLayout().docHeight+"px;top: 0;left: 0;background: #000;filter: alpha(opacity=50);opacity: .5;z-index: "+overlayIndex;
document.body.insertBefore(overlay,document.body.firstChild);},toggleOverlay:function(show){var self=this;var resizeOverlay=function(el){el.style.cssText+=";width: "+getDocumentLayout().docWidth+"px;height: "+getDocumentLayout().docHeight+"px";
};if(this.overlayEl){if(show===true){this.overlayEl.style.cssText+=";display: block";resizeOverlay(this.overlayEl);}else{this.overlayEl.style.cssText+=";display: none";
}}if(!hasBindResize){hasBindResize=true;addEvent(window,"resize",function(){for(var i=0;i<overlays.length;i++){resizeOverlay(overlays[i]);}});}},bindDragEvent:function(defaultEvent){var self=this;
var dragEventFn=function(e,target){var elStyle=this.el.style,elTop=this.el.offsetTop,elLeft=this.el.offsetLeft;var beginPos={x:e.pageX||e.clientX,y:e.pageY||e.clientY},endPos={};
elStyle.marginLeft=elStyle.marginTop="";elStyle.cssText+=";top: "+elTop+"px;left: "+elLeft+"px;";document.onmousemove=function(e){e=window.event||e;endPos={x:e.pageX||e.clientX,y:e.pageY||e.clientY};
elStyle.cssText+=";top: "+(elTop+endPos.y-beginPos.y)+"px;left: "+(elLeft+endPos.x-beginPos.x)+"px;";};document.onmouseup=function(){document.onmouseup=document.onmousemove=document.onselect=null;
};};defaultEvent["mousedown#popDrag"]=dragEventFn;},layoutFix:function(){var offX=-this.el.offsetWidth/2+"px";offY=-this.el.offsetHeight/2+"px";if(isIE6){this.el.style.cssText+=";top: "+getViewLayout().height+"px;left: "+getViewLayout().width+"px;";
}else{this.el.style.cssText+=";top: 50%;left: 50%;";}this.el.style.cssText+=";margin-top: "+offY+";margin-left: "+offX;}};return Popbox;})();function CMTReplyEditor(){Editor.call(this);
this.uuid=common.generator("editor_");this.placeHolder="";this.replyFloor=0;this.referrerHtml="";this.init();}extend(Editor,CMTReplyEditor);CMTReplyEditor.prototype.init=function(){this.render();
this._init.call(this);this.bindEvent();};CMTReplyEditor.prototype.render=function(){var self=this;var cmt=document.createElement("div");var tpl=common.getCmtTpl({isPop:true,id:self.id,uuid:self.uuid,type:"postcomment_reply"});
cmt.className="cmtarea cmtarea-reply";cmt.style.cssText+=";display: none";cmt.innerHTML=tpl;document.body.insertBefore(cmt,document.body.firstChild);this.editor=cmt;
common.instances[this.uuid]=this;cmt=null;};CMTReplyEditor.prototype.prepareEditor=function(target,el){var targetId=getData(target,"target"),ret;var getOuterHTML=function(el){var tmp=document.createElement("div"),ret;
tmp.appendChild(el.cloneNode(true));ret=tmp.innerHTML;tmp=undefined;return ret;};var placeHolder=function(parent){return"回复"+getData(parent,"floor")+"楼("+getData(parent,"nick")+"):";
};var curReply=getParent(target,"cmtList-detail");var curReply_cmt=getChild(curReply,function(el){return el.className==="cmtList-detail-commment";});var curReply_header=getChild(curReply,function(el){return el.className==="cmtList-detail-header";
});this.replyFloor=getData(curReply,"floor");this.placeHolder=placeHolder(curReply);this.cmtUrl=el.cmtUrl;this.cmtTitle=el.cmtTitle;ret=curReply.cloneNode(false);
ret.appendChild(curReply_header.cloneNode(true));ret.appendChild(curReply_cmt.cloneNode(true));this.referrerHtml=getOuterHTML(ret);curReply.appendChild(this.editor);
setData(getElementsByClassName("cmtarea-sendBtn",this.editor)[0],"target",targetId);setData(getElementsByClassName("cmtarea-captcha-change",this.editor)[0],"target",targetId);
this.needCaptcha=el.needCaptcha;if(this.needCaptcha){el.showCaptcha();if(this.targetId!==targetId){common.changeCaptcha(el);}}else{el.hideCaptcha();}this.targetId=targetId;
};CMTReplyEditor.prototype.show=function(){this.editor.style.cssText+=";display: block;";};CMTReplyEditor.prototype.close=function(){this.editor.style.cssText+=";display: none;";
};CMTReplyEditor.prototype.reset=function(){this.close();document.body.insertBefore(this.editor,document.body.firstChild);};var UserControl={init:function(){this.renderLoginPop();
this.bindLoginPopEvent();},renderLoginPop:function(){var loginPop,floBG;if(!document.getElementById("pl_login")){this.loginPop=loginPop=document.createElement("div");
loginPop.className="expFB";loginPop.id="pl_login";loginPop.style.cssText+=";display: none";loginPop.innerHTML='<iframe name="loginIframe" id="loginIframe" width=0 height=0 scrolling="no" frameborder="0" style="visibility:hidden"></iframe><form action="'+CONFIG.loginUrl+'" method="post" target="loginIframe" id="loginForm" accept-charset="GBK"><input id="auto_login" name="auto_login" type="hidden" value="3600" /><input type="hidden" name="return" value="'+CONFIG.proxyUrl+'"><div class="th"><span class="mark">通行证登录</span><span class="subMark"><a href="#" class="close" id="pl_closeBtn">关闭</a></span></div><div class="tb"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><th class="col1">&nbsp;</th><th class="col34"><font color="red" id="msg"></font></th></tr><tr><td align="right" class="col1">用户名：&nbsp;</td><td class="col34"><input type="text" maxlength="20" class="input grayInput" name="username" id="usernameInput" title="请填写用户名"></td></tr><tr><td class="col1">密&nbsp;&nbsp;码：&nbsp;</td><td class="col34"><input type="password" maxlength="20" class="input grayInput" name="password" id="passwordInput" title="请输入密码"></td></tr><tr><td class="col1"></td><td class="col34"></td></tr><tr><td style="height: 30px; line-height: 30px;" class="col1">&nbsp;</td><td style="font-size: 12px; height: 30px; line-height: 30px;" class="col34"><input type="checkbox" style="border: 0pt none; vertical-align: middle; margin-top: -4px;" id="auto_login" value="3000" name="auto_login"><label for="auto_login">&nbsp;记住登录状态</label></td></tr><tr><td class="col1">&nbsp;</td><td class="col34"><input type="submit" style="border: medium none;" value="登&nbsp;录" id="loginBtn" name="loginBtn" class="regbut"><a href="'+CONFIG.forgotUrl+'"  class="getpass" target="_blank">忘记密码？</a></td></tr></tbody></table></div><div class="tf">还没有注册太平洋通行证？点击<a href="'+CONFIG.registerUrl+'" target="_blank">立即注册</a></div></form>';
document.body.insertBefore(loginPop,document.body.firstChild);this.msg=document.getElementById("msg");}if(!document.getElementById("floBG")){this.floBG=floBG=document.createElement("div");
floBG.className="floBG";floBG.id="floBG";document.body.insertBefore(floBG,document.body.firstChild);}},checkLogin:function(){return Cookie.get(CONFIG.cmuName)&&Cookie.get(CONFIG.sidName);
},doLogin:function(resolve,reject,extra){var cset=extra&&extra.charset;if(cset&&cset!==CONFIG.pageEncoding){document.charset=cset;}var time=0,self=this;
var checker=setInterval(function(){var isIn=self.checkLogin();if(time++<30&&!isIn){return;}clearInterval(checker);if(cset&&cset!==CONFIG.pageEncoding){document.charset=CONFIG.pageEncoding;
cset=null;}if(isIn){resolve&&resolve();}else{reject&&reject();}},100);},getUser:function(callback){var self=this;if(common.userData){return setTimeout(function(){callback(common.userData);
},0);}jsonp(CONFIG.userUrl,function(data){common.userData=data;callback(data);});},getUserIp:function(callback){var cookie=Cookie.get(CONFIG.COOKIE_NAME_IP),self=this;
if(cookie){callback(decodeURIComponent(cookie));}else{this.fetchUserIp(callback);}},fetchUserIp:function(callback){jsonp(CONFIG.ipUrl,function(location){var area="";
if(location.pro==location.city){area=location.city;}else{area=location.pro+location.city;}if(!area){area=1;}Cookie.set(CONFIG.COOKIE_NAME_IP,encodeURIComponent(area),{path:"/",domain:CONFIG.domain});
return callback(area);});},flushFace:function(data){var self=this;[].forEach.call(getElementsByClassName("cmtarea-section-content-avatorHolder"),function(el){el.src=self.getAvator(data.id);
});},getAvator:function(id){if(!id||id<=0){return CONFIG.defaultAvatar;}id=""+id;var ret=[],i=0,l=id.length;while(i+2<=l){ret.push(id.slice(i,i+2));i+=2;
}if(i<l){ret.push(id.charAt(i));}return"http://i1.3conline.com/images/upload/upc/face/"+ret.join("/")+"/"+id+"_50x50";},renderAccountInfo:function(){var tpl='欢迎您，<a href="'+CONFIG.usercenterUrl+'" target="_blank">{{username}}</a><b class="cmtarea-account-separator">|</b><a href="{{logoutUrl}}" class="cmt-area-account-logout">退出</a>';
var offlineMsg=getElementsByClassName("cmtarea-account");var onlineMsg=getElementsByClassName("cmtarea-account-online"),asyncArea=getElementsByClassName("cmtarea-async"),self=this;
if(this.checkLogin()){this.getUser(function(user){[].forEach.call(offlineMsg,function(dom){dom.style.cssText+=";display: none";});[].forEach.call(onlineMsg,function(dom){dom.innerHTML=tpl.replace(/{{username}}/g,user.nickName).replace(/{{logoutUrl}}/g,CONFIG.logoutUrl+"?return="+encodeURIComponent(CONFIG.pageUrl));
dom.style.cssText+=";display: block";});[].forEach.call(asyncArea,function(dom){dom.style.cssText+=";display: inline-block";});self.flushFace(user);self.asyncInit(user);
common.resetCaptchaStatus();});}},bindLoginPopEvent:function(){var plCloseBtn=document.getElementById("pl_closeBtn"),plForm=document.getElementById("loginForm"),self=this;
var doSubmit=function(e){var user=document.getElementById("usernameInput"),psw=document.getElementById("passwordInput"),msg=document.getElementById("msg"),charset=this.acceptCharset;
if(user.value==""){msg.innerHTML="请输入用户名";return false;}if(psw.value==""){msg.innerHTML="请输入密码";return false;}self.doLogin(function(){self.renderAccountInfo();
self.hideLoginPop();common.resetCaptchaStatus();},function(){msg.innerHTML='<span style="color:red">登录失败! 请检查帐号和密码是否正确。</span>';},{charset:charset});return true;
};var closePop=function(e){preventDefault(e);self.hideLoginPop();};addEvent(plForm,"submit",doSubmit);addEvent(plCloseBtn,"click",closePop);},showLoginPop:function(){this.loginPop.style.cssText+=";display: block;";
this.floBG.style.cssText+=";display: block;";},hideLoginPop:function(){this.loginPop.style.cssText+=";display: none;";this.floBG.style.cssText+=";display: none;";
this.msg.innerHTML="";},asyncInit:function(data){this.accountId=data.id;[].forEach.call(getElementsByClassName(".cmtarea-async"),function(dom){dom.style.cssText+="display: inline-block;";
});this.prepareAsync(data.id);},prepareAsync:function(id){var types=["qzone","sina"],self=this;this.asyncStatus={};for(var i=0,l=types.length;i<l;i++){types[i]+="_"+CONFIG.sign;
}var url=CONFIG.bindStatusUrl+"?id="+id+"&type="+types.join(",");jsonp(url,function(status){if(status.status==-1){return;}var data=status.data,name;for(var i=0,l=data.length;
i<l;i++){name=data[i]["enName"];name=name.slice(0,name.indexOf("_"+CONFIG.sign));self.asyncStatus[name]=data[i];}});},getSyncStr:function(){var str="",arr=[],siteSyncSelect=this.siteSyncSelect;
for(var i in siteSyncSelect){if(siteSyncSelect[i]){arr.push(i);}}return arr.join(",");},async:function(el){var siteText={sina:"新浪微博",qzone:"QQ"};var type=getData(el,"type"),asyncStatus=this.asyncStatus;
if(!asyncStatus[type].isBand){this.popbox.reDraw(function(){var tpl='<div class="popbox-container"><div class="pop-header" data-event="popDrag"><strong>提示</strong><a href="javascript:;" class="pop-header-close" data-event="popClose">x</a></div><div class="pop-section">您的账号还没与'+siteText[type]+'账号进行绑定，是否现在进行绑定？</div><div class="pop-footer"><a href="javascript:;" class="pop-footer-async" data-event="popAsync" data-type="'+type+"_"+CONFIG.sign+'">确定</a><a href="javascript:;" class="pop-footer-cancle" data-event="popClose">取消</a></div></div>';
return tpl;}).show();}else{this.siteSyncSelect=this.siteSyncSelect||{};this.siteSyncSelect[type]=this.siteSyncSelect[type]?0:1;this.toggleAsyncStatus(el,type);
}},toggleAsyncStatus:function(el,type){var elClassname="cmtarea-async-"+type,reg;if(this.siteSyncSelect[type]===1){[].forEach.call(getElementsByClassName(elClassname),function(dom){dom.className+=" "+elClassname+"-on";
});}else{reg=new RegExp("\\s*("+elClassname+"-on)\\s*","g");[].forEach.call(getElementsByClassName(elClassname),function(dom){dom.className=dom.className.replace(reg,"");
});}}};function Reply(config,isPost){var msg=!isPost?'<a href="javascrip:;" class="cmtList-detail-tools-vote" data-disabled="false" data-event="cmtVote" data-id="{{id}}">顶<em>[<b>{{vote}}</b>]</em><i>+1</i></a><a href="javascrip:;" data-event="reply" data-target="'+config.uuid+'">回复</a><span class="cmtList-detail-tools-share"><div class="shareH">分享<em></em></div><div data='+config.bdshare+' class="bdshare_t bds_tools get-codes-bdshare" id="bdshare"><a class="bds_tsina" title="分享到新浪微博" href="#">新浪微博</a><a class="bds_tqq" title="分享到腾讯微博" href="#">腾讯微博</a><a class="bds_qzone" title="分享到QQ空间" href="#">QQ空间</a></div></span>':'<em class="cmtList-detail-tools-msg">'+CONFIG.UN_AUDIT_MSG+"</em>";
this.isQuote=config.isQuote;this.data=!isPost?config.data:repkg(config.data);this.tpl='<div class="cmtList-avator">{{avator}}</div><div class="cmtList-detail" data-floor="{{floor}}" data-nick="{{nickName}}" data-uid="{{userId}}" data-time="{{time}}"><div class="cmtList-detail-header"><span class="cmtList-detail-floor">{{floor}}楼</span>{{usercenter}}<span class="cmtList-detail-time">{{time}}</span></div><!--reply--><p class="cmtList-detail-commment">{{content}}</p><div class="cmtList-detail-tools">'+msg+"</div></div>";
this.replyTpl=config.replyTpl||'<div class="cmtList-detail cmtList-detail-rep" data-floor="{{floor}}" data-nick="{{nickName}}" data-uid="{{userId}}" data-time="{{time}}"><!--reply--><div class="cmtList-detail-header"><span class="cmtList-detail-floor">{{floor}}楼</span>{{usercenter}}<span class="cmtList-detail-time">{{time}}</span></div><p class="cmtList-detail-commment">{{content}}</p><div class="cmtList-detail-tools"><a href="javascript:;" class="cmtList-detail-tools-vote" data-event="cmtVote" data-disabled="false" data-id="{{id}}">顶<em>[<b>{{vote}}</b>]</em><i>+1</i></a><a href="javascript:;" data-event="reply" data-target="'+config.uuid+'">回复</a><span class="cmtList-detail-tools-share"><div class="shareH">分享<em></em></div><div data='+config.bdshare+' class="bdshare_t bds_tools get-codes-bdshare" id="bdshare"><a class="bds_tsina" title="分享到新浪微博" href="#">新浪微博</a><a class="bds_tqq" title="分享到腾讯微博" href="#">腾讯微博</a><a class="bds_qzone" title="分享到QQ空间" href="#">QQ空间</a></div></span></div></div>';
function repkg(data){return{face:UserControl.getAvator(data.userId),floor:data.floor,userId:data.userId,content:data.brief,nickName:data.showName,createTime:"刚刚"};
}}Reply.prototype={render:function(){var list=document.createElement("div"),reply=this.data,replyTpl=this.replyTpl,isQuote=this.isQuote,tpl;var replaceReply=function(tpl,data,extra){extra=extra||{};
return tpl.replace(/{{avator}}/g,function(){if(data.userId){return'<a href="'+CONFIG.usercenterUrl+data.userId+'" target="_blank"><img src="'+data.face+'" width="50" height="50"></a>';
}else{return'<img src="'+data.face+'" width="50" height="50">';}}).replace(/{{floor}}/g,data.floor).replace(/{{userId}}/g,data.userId).replace(/{{usercenter}}/g,function(){var ret="";
if(data.userId>0){ret='<a href="'+CONFIG.usercenterUrl+data.userId+'" target="_blank" class="cmtList-detail-user">{{nickName}}</a>';}else{ret='<em class="cmtList-detail-user">{{nickName}}</em>';
}data.client&&extra.isMater&&(ret+=common.getClient(data.client));return ret;}).replace(/{{content}}/g,data.content).replace(/{{nickName}}/g,data.nickName).replace(/{{time}}/g,common.formatDate(data.createTime)).replace(/{{id}}/g,data.id).replace(/{{vote}}/g,data.support).replace(/{{content_stripTags}}/g,function(){var content=data.content;
content=content.replace(/<[^>]*>/g,"");if(content.length>70){content=content.substr(0,70)+"...";}return content;});};list.className="cmtList";tpl=replaceReply(this.tpl,reply,{isMater:true});
if(isQuote){tpl=tpl.replace("<!--reply-->",replaceReply(replyTpl,reply));}else{while(reply=reply.replyRef){tpl=tpl.replace("<!--reply-->",replaceReply(replyTpl,reply));
}}list.innerHTML=tpl;return list;}};function CMTEditor(config){config=config||{};Editor.call(this);this.parentEl=config.el;this.uuid=common.generator("cmt_");
this.cmtUrl=config.cmtUrl||CONFIG.pageUrl;this.cmtTitle=config.cmtTitle||CONFIG.title;this.placeHolder="注：所有评论通过审核后才会被公开。";this.bdshare='{text:"'+CONFIG.title.replace(/[\s\t\r\n\f]/g,"&nbsp;")+"的这条评论不错：（分享自@"+CONFIG.shareToken+'）{{content_stripTags}}"}',this.hasCmt=false;
this.pagination=config.pagination;this.curPage=1;this.limit=config.limit||CONFIG.limit;this.init();}extend(Editor,CMTEditor);CMTEditor.prototype.init=function(){this.render();
this.fetchReply();this.bindEvent();UserControl.renderAccountInfo();if(CONFIG.needCaptcha){this.showCaptcha();common.changeCaptcha(this);}};CMTEditor.prototype.render=function(){var self=this;
var parentEl=this.parentEl;var wrap=document.createElement("div");var cmt=this.editor=document.createElement("div");var footer=this.cmtFooter=document.createElement("div");
var cmtContent=this.cmtContent=document.createElement("div");if(parentEl){wrap.className="cmtcontainer";cmt.innerHTML=common.getCmtTpl({id:self.id,type:"postcomment",uuid:self.uuid});
cmt.className="cmtarea";cmtContent.className="cmtcontent";footer.className="cmtfooter";footer.innerHTML='<span class="cmtarea-cmtCount"></span>';wrap.appendChild(cmt);
wrap.appendChild(cmtContent);wrap.appendChild(footer);parentEl.appendChild(wrap);}common.instances[this.uuid]=this;this._init.call(this);parentEl=wrap=footer=cmt=cmtContent=null;
};CMTEditor.prototype.fetchReply=function(){var self=this,pagination=this.pagination;jsonp(CONFIG.baseUrl+CONFIG.getUrl+"&url="+this.cmtUrl+"&pageSize="+this.limit+"&pageNo="+this.curPage,function(data){if(data.total){self.hasCmt=true;
renderData(data);if(pagination){self.buildPagination(data.total);}renderCmtCount(data.total);common.bdshare(pagination);}else{renderCmtCount();}},null,{charset:"utf-8"});
function renderCmtCount(replys){common.getCmtCount(replys,self.cmtUrl,function(tpl){[].forEach.call(getElementsByClassName("cmtarea-cmtCount",self.parentEl),function(el){el.innerHTML=tpl;
});});}function renderData(data){if(pagination){self.cmtContent.innerHTML="";}var replys=data.data,fragment=document.createDocumentFragment();for(var i=0,l=replys.length;
i<l;i++){fragment.appendChild((new Reply({data:replys[i],uuid:self.uuid,bdshare:self.bdshare})).render());}self.cmtContent.appendChild(fragment);fragment=null;
}};CMTEditor.prototype.showCaptcha=function(){[].forEach.call(getElementsByClassName("cmtarea-captcha",this.parentEl),function(el){common.editors[getData(el,"rel")].needCaptcha=1;
el.style.cssText+=";display: inline-block";getElementsByClassName("cmtarea-captcha-value",el)[0].value="";});};CMTEditor.prototype.hideCaptcha=function(){[].forEach.call(getElementsByClassName("cmtarea-captcha",this.parentEl),function(el){common.editors[getData(el,"rel")].needCaptcha=0;
el.style.cssText+=";display: none";getElementsByClassName("cmtarea-captcha-value",el)[0].value="";});};CMTEditor.prototype.destroy=function(){this.parentEl.innerHTML="";
this.parentEl=null;};CMTEditor.prototype.buildPagination=function(total){this.maxPage=Math.ceil(total/this.limit);if(!this.pager){this.pager=document.createElement("div");
this.pager.className="cmtpagination";setData(this.pager,"target",this.uuid);this.cmtFooter.parentNode.insertBefore(this.pager,this.cmtFooter);}var tpl=['<a href="javascript:;" class="cmtpagination-prev'+(this.curPage===1?' cmtpagination-disabled"':'" data-event="cmtJumpPage" data-page="'+(this.curPage-1)+'"')+">&lt;</a>"];
for(var i=1,l=this.maxPage;i<=l;i++){tpl.push('<a href="javascript:;"'+(this.curPage===i?' class="cmtpagination-cur"':' data-event="cmtJumpPage" data-page="'+i+'"')+">"+i+"</a>");
}tpl.push('<a href="javascript:;" class="cmtpagination-next'+(this.curPage===this.maxPage?' cmtpagination-disabled"':'" data-event="cmtJumpPage" data-page="'+(this.curPage+1)+'"')+">&gt;</a></div>");
this.pager.innerHTML=tpl.join("");};var s=document.createElement("link");s.setAttribute("rel","stylesheet");s.href=CONFIG.cmtCssUrl;document.getElementsByTagName("head")[0].appendChild(s);
var replyEditor=new CMTReplyEditor;UserControl.popbox=new Popbox({dragable:true,events:{"click#popAsync":function(e,el){preventDefault(e);exports.open(CONFIG.oauthUrl+CONFIG.bindDoneUrl+"&type="+getData(el,"type")+"&return="+CONFIG.proxyUrl,"oauth");
this.close();}}});UserControl.init();_.highlight=_.slideMenu=null;var mouseoverHander=function(e){e=window.event||e;var target=e.target||e.srcElement,el,els;
_.highlight&&(_.highlight.style.visibility="hidden");_.slideMenu&&(_.slideMenu.className="cmtList-detail-tools-share");if(el=getParent(target,"cmtList-detail-rep")){els=getElementsByClassName("cmtList-detail-tools",el);
els.length&&((_.highlight=els[els.length-1]).style.visibility="visible");}if(el=getParent(target,"cmtList-detail-tools-share")){(_.slideMenu=el).className+=" cmtList-detail-tools-share-hover";
}};addEvent(document.body,"click",function(e){e=window.event||e;var target=e.target||e.srcElement,eventEl=getEvent(target,"event"),el=eventEl.target,eventType=eventEl.value,editor,insertTarget,cmtId;
if(eventType&&preventDefault(e)){switch(eventType){case"reply":insertTarget=common.instances[getData(el,"target")];replyEditor.prepareEditor(el,insertTarget);
replyEditor.setPlaceHolder();replyEditor.show();break;case"cmtlogin":UserControl.showLoginPop();break;case"postcomment_reply":insertTarget=common.instances[getData(el,"target")];
common.post(el,function(data){common.RenderComment(insertTarget,data,replyEditor.referrerHtml);},replyEditor);break;case"postcomment":insertTarget=common.instances[getData(el,"target")];
common.post(el,function(data){common.RenderComment(insertTarget,data);});break;case"cmtClose":replyEditor.close();break;case"toggleEmotion":common.toggleEmotion(el);
return;case"addEmotion":editor=common.editors[getData(target.parentNode,"rel")].content;common.addEmotion(editor,target);return;case"cmtVote":common.vote(el);
break;case"accountAsync":UserControl.async(el);break;case"cmtChangeCaptcha":common.changeCaptcha(common.instances[getData(el,"target")]);break;case"cmtJumpPage":replyEditor.reset();
insertTarget=common.instances[getData(el.parentNode,"target")];insertTarget.curPage=+getData(el,"page");insertTarget.fetchReply();insertTarget.cmtContent.scrollIntoView();
break;}}[].forEach.call(getElementsByClassName("cmtarea-account-emotions-list"),function(dom){if(getData(dom,"show")==="true"){common.toggleEmotion(dom.parentNode.getElementsByTagName("span")[0]);
}});});addEvent(document.body,"mouseover",mouseoverHander);CMTEditor.getCount=function(callback){jsonp(CONFIG.baseUrl+CONFIG.countUrl+CONFIG.pageUrl,function(data){if(data.total){return callback(data.total,data.url);
}else{return callback(0,"javascript:;");}});};exports.Comment=CMTEditor;})(window.CommentNS||{},window);